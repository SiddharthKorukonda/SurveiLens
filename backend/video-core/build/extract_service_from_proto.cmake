if(NOT DEFINED INPUT OR NOT DEFINED OUTPUT)
  message(FATAL_ERROR "extract_service_from_proto.cmake: need -DINPUT and -DOUTPUT")
endif()
file(READ "${INPUT}" CONTENTS)
# match first 'service <Name> {'
string(REGEX MATCH "service[ \t\r\n]+([A-Za-z0-9_]+)[ \t\r\n]*\{" MATCH "${CONTENTS}")
if(NOT MATCH)
  message(FATAL_ERROR "Could not find 'service <Name> {' in ${INPUT}")
endif()
string(REGEX REPLACE "service[ \t\r\n]+([A-Za-z0-9_]+)[ \t\r\n]*\{" "\\1" SVC "${MATCH}")
file(WRITE "${OUTPUT}" "#pragma once\n")
file(APPEND "${OUTPUT}" "// auto-generated at build time from pipeline.proto\n")
file(APPEND "${OUTPUT}" "namespace pipeline { }\n")
file(APPEND "${OUTPUT}" "using ServiceBase = ::pipeline::${SVC}::Service;\n")
file(APPEND "${OUTPUT}" "// detected service: ${SVC}\n")
